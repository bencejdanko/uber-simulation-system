# Billing Service API Documentation

**Version:** 1.0
**Base URL:** `/api/v1`
**Authentication:** Bearer Token (Specifics TBD - All endpoints should require authentication)
**Content-Type:** `application/json`

## Overview

The Billing Service is responsible for creating, managing, and retrieving billing information associated with completed rides. It links rides, customers, and drivers to specific financial transactions, including predicted and actual ride costs.

**Note on ID Formats:** The project specification requests SSN Format (xxx-xx-xxxx) for Billing ID, Ride ID, Customer ID, and Driver ID. While unconventional for Billing and Ride IDs (UUIDs are more common), this documentation adheres to the specification.

---

## Data Structures

### BillingInformation Object

Represents a billing record for a single ride.

```json
{
  "billingId": "string (SSN Format: xxx-xx-xxxx)", // As per spec
  "rideId": "string (SSN Format: xxx-xx-xxxx)",    // As per spec, links to the Ride
  "customerId": "string (SSN Format: xxx-xx-xxxx)", // Links to the Customer
  "driverId": "string (SSN Format: xxx-xx-xxxx)",   // Links to the Driver
  "date": "string (ISO 8601 Date Format: YYYY-MM-DD)", // Date of the ride/billing event
  "pickupTime": "string (ISO 8601 DateTime Format)",
  "dropoffTime": "string (ISO 8601 DateTime Format)",
  "distanceCovered": "number (e.g., miles or km)",
  "sourceLocation": {
    "latitude": "number",
    "longitude": "number",
    "addressLine": "string (Optional: textual representation)" // Optional
  },
  "destinationLocation": {
    "latitude": "number",
    "longitude": "number",
    "addressLine": "string (Optional: textual representation)" // Optional
  },
  "predictedAmount": "number (Currency, e.g., USD)", // Fare prediction shown to user initially
  "actualAmount": "number (Currency, e.g., USD)", // Final calculated fare (Total amount for ride)
  "paymentStatus": "string (Enum: PENDING, PAID, FAILED, VOID)", // Status of the payment
  "createdAt": "string (ISO 8601 Format)",
  "updatedAt": "string (ISO 8601 Format)"
}
```

### Billing Input Object (for POST)

Used in the request body when creating a new bill. Often triggered internally by the Rides service upon ride completion.

```json
{
  // billingId is typically generated by the service upon creation
  "rideId": "string (SSN Format: xxx-xx-xxxx)",    // Required
  "customerId": "string (SSN Format: xxx-xx-xxxx)", // Required
  "driverId": "string (SSN Format: xxx-xx-xxxx)",   // Required
  "date": "string (ISO 8601 Date Format: YYYY-MM-DD)", // Required
  "pickupTime": "string (ISO 8601 DateTime Format)", // Required
  "dropoffTime": "string (ISO 8601 DateTime Format)", // Required
  "distanceCovered": "number",                     // Required
  "sourceLocation": {                             // Required
    "latitude": "number",                         // Required
    "longitude": "number"                         // Required
  },
  "destinationLocation": {                        // Required
    "latitude": "number",                         // Required
    "longitude": "number"                         // Required
  },
  "predictedAmount": "number",                     // Required
  "actualAmount": "number"                         // Required
  // paymentStatus typically defaults to PENDING on creation
}
```

### Error Response Object

Standard format for error responses.

```json
{
  "error": "string (error code, e.g., 'invalid_input', 'not_found')",
  "message": "string (detailed error message)"
}
```

---

## Endpoints

### 1. Create Bill

*   **Description:** Creates a new billing record for a completed ride. This endpoint might be called internally by the Rides Service rather than directly by the client application.
*   **Endpoint:** `POST /bills`
*   **Request Body:** `Billing Input Object`
*   **Responses:**
    *   `201 Created`: Bill successfully created. Response body contains the created `BillingInformation Object`. Includes `Location` header: `/bills/{new_billing_id}`.
    *   `400 Bad Request`: Invalid input data (e.g., missing required fields, invalid ID formats, non-numeric amounts/distance, invalid dates). Response body contains `Error Response Object`.
        *   Example Error Codes: `invalid_input`, `missing_required_field`, `invalid_id_format`, `invalid_amount`, `invalid_date_format`.
    *   `409 Conflict`: A billing record for the specified `rideId` might already exist (depending on business logic - can a ride be billed twice?). Or potentially if the provided `billingId` (if allowed in input) is already taken.
        *   Example Error Code: `duplicate_bill_for_ride`, `duplicate_billing_id`.
    *   `500 Internal Server Error`: Unexpected server error.

### 2. Get Bill by ID

*   **Description:** Retrieves the details of a specific billing record.
*   **Endpoint:** `GET /bills/{billing_id}`
*   **Path Parameters:**
    *   `billing_id` (string, required): The SSN format ID of the bill to retrieve.
*   **Responses:**
    *   `200 OK`: Bill details successfully retrieved. Response body contains the `BillingInformation Object`.
    *   `400 Bad Request`: Invalid `billing_id` format provided in the path. Response body contains `Error Response Object`.
        *   Example Error Code: `invalid_billing_id_format`.
    *   `404 Not Found`: No bill found with the specified `billing_id`. Response body contains `Error Response Object`.
        *   Example Error Code: `bill_not_found`.
    *   `500 Internal Server Error`: Unexpected server error.

### 3. Search/List Bills

*   **Description:** Retrieves a list of billing records, optionally filtered by provided criteria. Useful for admin reporting or displaying history to customers/drivers.
*   **Endpoint:** `GET /bills`
*   **Query Parameters (Optional):**
    *   `customer_id` (string, SSN Format): Filter by customer ID.
    *   `driver_id` (string, SSN Format): Filter by driver ID.
    *   `ride_id` (string, SSN Format): Filter by ride ID.
    *   `payment_status` (string, Enum: PENDING, PAID, FAILED, VOID): Filter by payment status.
    *   `start_date` (string, YYYY-MM-DD): Filter bills on or after this date.
    *   `end_date` (string, YYYY-MM-DD): Filter bills on or before this date.
    *   `limit` (integer, default: 20): Maximum number of results to return (for pagination).
    *   `offset` (integer, default: 0): Number of results to skip (for pagination).
*   **Responses:**
    *   `200 OK`: Successfully retrieved list of bills. Response body contains a JSON array of `BillingInformation Object`s matching the criteria. The array might be empty if no bills match. Include pagination headers if implemented (e.g., `X-Total-Count`).
    *   `400 Bad Request`: Invalid format for query parameters (e.g., invalid ID format, invalid date format, invalid payment status enum). Response body contains `Error Response Object`.
        *   Example Error Code: `invalid_query_parameter`, `invalid_id_format`, `invalid_date_format`, `invalid_payment_status`.
    *   `500 Internal Server Error`: Unexpected server error.

### 4. Delete Bill

*   **Description:** Removes a billing record from the system. **Note:** In real financial systems, deletion is rare. Marking a bill as "VOID" or "CANCELLED" via a PATCH update is often preferred for audit trails. This endpoint is included as per the project requirements ("Delete an existing Bill"). Consider implications carefully.
*   **Endpoint:** `DELETE /bills/{billing_id}`
*   **Path Parameters:**
    *   `billing_id` (string, required): The SSN format ID of the bill to delete.
*   **Responses:**
    *   `204 No Content`: Bill successfully deleted. No response body.
    *   `400 Bad Request`: Invalid `billing_id` format provided in the path. Response body contains `Error Response Object`.
        *   Example Error Code: `invalid_billing_id_format`.
    *   `404 Not Found`: No bill found with the specified `billing_id`. Response body contains `Error Response Object`.
        *   Example Error Code: `bill_not_found`.
    *   `500 Internal Server Error`: Unexpected server error.
    *   `403 Forbidden` (Optional): If deletion is restricted based on payment status or user roles.

---

## Validation Notes

*   **ID Formats:** All `billingId`, `rideId`, `customerId`, `driverId` fields must strictly adhere to the specified `xxx-xx-xxxx` format.
*   **Dates/Times:** Validate adherence to ISO 8601 formats.
*   **Numeric Fields:** Ensure `distanceCovered`, `predictedAmount`, `actualAmount` are valid numbers. Amounts should likely be non-negative.
*   **Locations:** Validate latitude (-90 to 90) and longitude (-180 to 180).
*   **Payment Status:** If provided in search filters or update requests, validate against the allowed enum values (PENDING, PAID, FAILED, VOID).

## Considerations

*   **Bill Creation Trigger:** Decide if bill creation (`POST /bills`) is triggered by the Rides Service upon ride completion or if another mechanism is used. The API is provided, but the trigger mechanism needs definition.
*   **Payment Processing:** This service focuses on *recording* billing information. Actual payment processing (charging credit cards) would typically involve interaction with a separate Payment Gateway service, which might then update the `paymentStatus` on the bill (e.g., via a PATCH endpoint not detailed here, or internal updates).
*   **Deletion vs. Voiding:** Carefully consider the implications of allowing hard deletion of billing records. An update mechanism to set `paymentStatus` to `VOID` is generally better practice for financial records.